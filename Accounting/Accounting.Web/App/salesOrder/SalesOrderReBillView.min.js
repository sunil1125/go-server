define(["require","exports","plugins/router","durandal/app","salesOrder/SalesOrderReBillItemView","salesOrder/SalesOrderOptionButtonControl","services/models/common/Enums","services/models/salesOrder/RequoteBillModel","services/client/SalesOrderClient","services/validations/Validations","services/models/salesOrder/SalesOrderShipmentRequoteReason","services/models/salesOrder/SalesOrderItemDetail"],function(n,t,i,r,u,f,e,o,s,h,c,l){var tt=i,p=r,v=u,w=f,a=e,b=o,k=s,y=h,d=c,g=l,nt=function(){function n(n){this.adjustedOrderItemList=ko.observableArray([]),this.copyAdjustedOrderItemList=ko.observableArray([]),this.salesOrderClient=new k.SalesOrderClient,this.name=ko.observable("Other"),this.rebillRep=ko.observable(""),this.requoteReasonid=ko.observable(0),this.oldOrgZip=ko.observable(""),this.oldDestZip=ko.observable(""),this.oldTotalWeigth=ko.observable(0),this.oldTotalAmount=ko.observable($.number(0,2)),this.oldTotalCost=ko.observable($.number(0,2)),this.oldClass=ko.observable(""),this.newClass=ko.observable(""),this.newOrgZip=ko.observable(""),this.newDestZip=ko.observable(""),this.isOtherReason=ko.observable(!1),this.otherReason=ko.observable(""),this.costDiff=ko.observable($.number(0,2)),this.newTotalWeight=ko.observable(0),this.newTotalCost=ko.observable($.number(0,2)),this.newTotalAmount=ko.observable($.number(0,2)),this.estimatedProfitPerc=ko.observable($.number(0,2)),this.finalProfitPerc=ko.observable($.number(0,2)),this.html=ko.observable(""),this.crrReviewDate=ko.observable(""),this.adjustmentDate=ko.observable(""),this.salesOrderId=ko.observable(""),this.calculateRevenue=ko.observable(!1),this.isBillingStation=ko.observable(!1),this.gtzMargin=ko.observable($.number(0,2)),this.feeStructure=ko.observable(0),this.plcMargin=ko.observable(0),this.gtMinMargin=ko.observable(0),this.plcorBSCost=ko.observable(0),this.plcorBSRevenue=ko.observable(0),this.customerTypeOf=ko.observable(0),this.btnCopyEnable=ko.observable(!1),this.auditFeeItemsList=ko.observableArray([]),this.requoteReasonsList=ko.observableArray([]),this.salesOrderOptionListOptions=ko.observableArray([]),this.commonUtils=new Utils.Common,this.shipmentItemTypes=ko.observableArray([]),this.matchrowArray=ko.observableArray([]),this.checkMsgDisplay=!0,this.currentUser=ko.observable();var t=this;t.revenueChanged=n,t.salesOrderReBillOriginalItemViewModel=new v.SalesOrderReBillItemViewModel,t.salesOrderReBillAdjustItemViewModel=new v.SalesOrderReBillItemViewModel,t.bindRequoteReasonCodes(),t.datepickerOptions={blockWeekend:!0,blockPreviousDays:!1,blockHolidaysDays:!0,autoClose:!0,placeBelowButton:!1},t.checkMsgClick=function(){t.checkMsgDisplay=!0},t.checkMsgHide=function(){t.checkMsgDisplay=!0},t.currentUser()||p.trigger("GetCurrentUserDetails",function(n){t.currentUser(n)})}return n.prototype.initializeReBillDetails=function(n,t,i,r,u,f,e,o,s,h,c,l,v,y){var p=this,w,k;p.salesOrderId(n.toString()),p.btnCopyEnable(!0),p.estimatedProfitPerc(i),p.finalProfitPerc(r),p.gtzMargin(f),p.feeStructure(o),p.plcMargin(e),p.gtMinMargin(s),p.isBillingStation(u),p.customerTypeOf(h),p.newTotalCost(c),p.salesOrderReBillOriginalItemViewModel.selected(!1),l?p.costDiff(parseFloat(v.toString().replace(/,/g,""))-parseFloat(y.toString().replace(/,/g,""))):t===undefined||t===null?p.costDiff(parseFloat(c.toString().replace(/,/g,""))-0):p.costDiff(parseFloat(c.toString().replace(/,/g,""))-parseFloat(t.toString().replace(/,/g,""))),w=function(n){if(n!=null&&p.salesOrderReBillOriginalItemViewModel.initializeSalesOrderRebillItemDetails(n.OriginalItemDetail),p.adjustedOrderItemList(n.AdjustedItemDetail),p.salesOrderReBillOriginalItemViewModel.isSelect(!0),p.salesOrderReBillOriginalItemViewModel.isRev(!0),p.salesOrderReBillOriginalItemViewModel.isHaz(!0),p.salesOrderReBillOriginalItemViewModel.gridHeader("Original Order"),l||p.salesOrderReBillAdjustItemViewModel.initializeSalesOrderRebillItemDetails(n.AdjustedItemDetail),p.salesOrderReBillAdjustItemViewModel.isSelect(!1),p.salesOrderReBillAdjustItemViewModel.isRev(!0),p.salesOrderReBillAdjustItemViewModel.isHaz(!0),p.salesOrderReBillAdjustItemViewModel.gridHeader("Adjusted Order"),p.isBillingStation()?(p.salesOrderReBillAdjustItemViewModel.isBSCost(!0),p.salesOrderReBillOriginalItemViewModel.isBSCost(!0)):(p.salesOrderReBillAdjustItemViewModel.isBSCost(!1),p.salesOrderReBillOriginalItemViewModel.isBSCost(!1)),p.oldClass(n.OldClass),n.SalesOrderDetails!=null&&(p.oldOrgZip(n.SalesOrderDetails.OriginZip),p.oldDestZip(n.SalesOrderDetails.DestinationZip),p.oldTotalWeigth(n.SalesOrderDetails.TotalWeight),p.oldTotalAmount($.number(n.SalesOrderDetails.Revenue,2)),p.oldTotalCost($.number(n.SalesOrderDetails.Cost,2))),l?p.newClass(""):p.newClass(n.NewClass),n.SalesOrderRequoteReviewDetails!=null?(p.requoteReasonid(n.SalesOrderRequoteReviewDetails.ID),l?(p.rebillRep(p.currentUser().FullName),p.adjustmentDate(""),p.crrReviewDate("")):(p.rebillRep(n.SalesOrderRequoteReviewDetails.ReviewedBy),p.adjustmentDate(n.SalesOrderRequoteReviewDetails.AdjustmentDate?p.commonUtils.formatDate(n.SalesOrderRequoteReviewDetails.AdjustmentDate.toString(),"mm/dd/yyyy"):""),p.crrReviewDate(n.SalesOrderRequoteReviewDetails.CRReviewDate?p.commonUtils.formatDate(n.SalesOrderRequoteReviewDetails.CRReviewDate.toString(),"mm/dd/yyyy"):""))):p.rebillRep(p.currentUser().FullName),p.auditFeeItemsList.removeAll(),n.SalesOrderRequoteReasonCodes.forEach(function(n){p.auditFeeItemsList.push(new b.Model.RequoteBillModel(n))}),p.requoteReasonsList.removeAll(),n.SalesOrderShipmentRequoteReasons.forEach(function(n){p.requoteReasonsList.push(new d.Model.SalesOrderShipmentRequoteReason(n))}),p.requoteReasonsList().forEach(function(n){n.RequoteReasonID==11&&(l?(p.isOtherReason(!1),p.otherReason("")):(p.isOtherReason(!0),p.otherReason(n.Remarks)),p.html('<i class="icon-ok icon-white active"><\/i>'+p.name()))}),p.salesOrderOptionListOptions.removeAll(),p.auditFeeItemsList().length>0){p.auditFeeItemsList().forEach(function(n){if(n.id!=11){var t=!1;l||p.requoteReasonsList().forEach(function(i){i.RequoteReasonID==n.id&&(t=!0)}),p.salesOrderOptionListOptions.push({id:n.id,name:n.name,selected:t,enabled:n.IsEnable})}});var t={options:p.salesOrderOptionListOptions(),useHtmlBinding:!0,isMultiCheck:!0,isVerticalView:!1};p.obcSalesOrderOptionList.initializeButton(t,a.Enums.OptionButtonsView.Matrix)}},k=function(){},p.salesOrderClient.GetSalesOrderRebill(n.toString(),w,k)},n.prototype.bindRequoteReasonCodes=function(){var n=this,t=[{id:a.Enums.vendorBillOptionConstant.MakeInactive,name:"Make Inactive",selected:!1}],i={options:t,useHtmlBinding:!0,isMultiCheck:!0,isVerticalView:!1};n.obcSalesOrderOptionList=new w.SalesOrderOptionButtonControl(i,a.Enums.OptionButtonsView.Vertical)},n.prototype.otherOption=function(){var n=this;n.isOtherReason()?n.isOtherReason(!1):(n.isOtherReason(!0),n.html('<i class="icon-ok icon-white active"><\/i>'+n.name()))},n.prototype.convertToCrrReviewDate=function(){var n=this;n.crrReviewDate()!==undefined&&!n.crrReviewDate().match("/")&&n.crrReviewDate().length>0&&n.crrReviewDate(y.Validations.CommonDate.prototype.ConvertToDate(n.crrReviewDate()))},n.prototype.convertToAdjustmentDate=function(){var n=this;n.adjustmentDate()!==undefined&&!n.adjustmentDate().match("/")&&n.adjustmentDate().length>0&&n.crrReviewDate(y.Validations.CommonDate.prototype.ConvertToDate(n.adjustmentDate()))},n.prototype.copyCostRevenue=function(){var n=this,t,i;n.btnCopyEnable(!1),t=$.grep(n.salesOrderReBillOriginalItemViewModel.salesOrderOriginalItemsList(),function(n){return n.isCheck()}),n.copyAdjustedOrderItemList(n.adjustedOrderItemList()),t.length>0?(n.copyCostAndRevenueFromTab(t,!0),n.calculateRevenue(!0),n.calculateRevenueForChanges(),n.revenueChanged(n.adjustedOrderItemList()),n.calculateRevenue(!0)):n.checkMsgDisplay&&(n.checkMsgDisplay=!1,i={toastrPositionClass:"toast-top-middle",delayInseconds:15,fadeOut:15,typeOfAlert:"",title:""},Utility.ShowToastr(!0,ApplicationMessages.Messages.PleaseSelectanItem,"Success",n.checkMsgClick,i,n.checkMsgHide)),n.btnCopyEnable(!0)},n.prototype.copyCostOnly=function(){var n=this,t,i;n.btnCopyEnable(!1),t=$.grep(n.salesOrderReBillOriginalItemViewModel.salesOrderOriginalItemsList(),function(n){return n.isCheck()}),n.copyAdjustedOrderItemList(n.adjustedOrderItemList()),t.length>0?(n.copyCostAndRevenueFromTab(t,!1),n.calculateRevenueForChanges(),n.revenueChanged(n.adjustedOrderItemList())):n.checkMsgDisplay&&(n.checkMsgDisplay=!1,i={toastrPositionClass:"toast-top-middle",delayInseconds:15,fadeOut:15,typeOfAlert:"",title:""},Utility.ShowToastr(!0,ApplicationMessages.Messages.PleaseSelectanItem,"Success",n.checkMsgClick,i,n.checkMsgHide)),n.btnCopyEnable(!0)},n.prototype.copyCostAndRevenueFromTab=function(n,t){var i=this,r;i.matchrowArray().removeAll(),r=n.length,n.forEach(function(n){var f=n.itemId(),u=$.grep(i.adjustedOrderItemList(),function(n){return n.ItemId===f}),r;u!=null&&u.length>0?(i.fetchTheMatchedRow(n),i.matchrowArray().length==1?i.matchrowArray()[0].isUpdated?i.addnewRow(n):(i.matchrowArray()[0].Cost=n.cost(),t&&(i.matchrowArray()[0].PLCCost=n.bSCost(),i.matchrowArray()[0].Revenue=n.rev()),i.matchrowArray()[0].isUpdated=!0,i.copyRow(n,i.matchrowArray()[0].Id,t)):i.matchrowArray().length>1?(r=0,i.matchrowArray()[r].isUpdated?(r=r+1,i.matchrowArray()[r].Cost=n.cost(),t&&(i.matchrowArray()[r].PLCCost=n.bSCost(),i.matchrowArray()[r].Revenue=n.rev()),i.matchrowArray()[r].isUpdated=!0):(i.matchrowArray()[r].Cost=n.cost(),t&&(i.matchrowArray()[r].PLCCost=n.bSCost(),i.matchrowArray()[r].Revenue=n.rev()),i.matchrowArray()[r].isUpdated=!0,i.addnewRow(n))):i.addnewRow(n)):i.addnewRow(n)})},n.prototype.fetchTheMatchedRow=function(n){var t=this;t.matchrowArray().removeAll(),n.itemId()==parseInt(Constants.ApplicationConstants.ShippingItemId)?t.adjustedOrderItemList().forEach(function(){t.matchrowArray($.grep(t.adjustedOrderItemList(),function(t){return t.ItemId===n.itemId()&&t.UserDescription===n.userDescription()&&t.Class===n.selectedClassType()}))}):t.adjustedOrderItemList().forEach(function(){t.matchrowArray($.grep(t.adjustedOrderItemList(),function(t){return t.ItemId===n.itemId()&&t.UserDescription===n.userDescription()}))})},n.prototype.calculateRevenueForChanges=function(){var n=this,i=!1,r=n.salesOrderId().search(" "),t;r!=-1&&(i=!0),t=0,t=i?n.finalProfitPerc():n.estimatedProfitPerc(),n.adjustedOrderItemList().forEach(function(i){i.isUpdated&&(n.plcorBSCost(0),n.plcorBSRevenue(0),n.calculatePLCorBSCostAndRevenue(i.Cost,n.customerTypeOf(),t),n.calculateRevenue()||(i.Revenue=$.number(n.plcorBSRevenue(),2),i.PLCCost=$.number(n.plcorBSCost(),2)))})},n.prototype.calculatePLCorBSCostAndRevenue=function(n,t,i){var r=this,e=r.commonUtils.isNullOrEmptyOrWhiteSpaces(r.gtzMargin())?r.gtzMargin():0,o=r.commonUtils.isNullOrEmptyOrWhiteSpaces(r.plcMargin())?r.plcMargin():0,u=0,f=0,s=r.gtMinMargin();switch(r.feeStructure()){case a.Enums.FeeStructure.OverCost.ID:r.isBillingStation()?(u=$.number(parseFloat(n.toString().replace(/,/g,""))/(1-parseFloat(e.toString().replace(/,/g,""))/100),2),n!=0&&(f=$.number(parseFloat(n.toString().replace(/,/g,""))+parseFloat(s.toString().replace(/,/g,"")),2)),r.plcorBSCost(u>f?u:f)):r.plcorBSCost($.number(parseFloat(n.toString().replace(/,/g,""))+parseFloat(n.toString().replace(/,/g,""))*parseFloat(n.toString().replace(/,/g,""))/100,2)),r.isBillingStation()&&r.plcorBSRevenue($.number(parseFloat(n.toString().replace(/,/g,""))*100/(100-parseFloat(o.toString().replace(/,/g,""))),2));break;case a.Enums.FeeStructure.OverRevenue.ID:r.plcorBSRevenue()==0&&r.isBillingStation()&&r.plcorBSRevenue($.number(parseFloat(n.toString().replace(/,/g,""))*100/(100-parseFloat(o.toString().replace(/,/g,""))),2)),u=$.number(parseFloat(n.toString().replace(/,/g,""))+(parseFloat(r.plcorBSRevenue().toString().replace(/,/g,""))-parseFloat(n.toString().replace(/,/g,""))+parseFloat(e.toString().replace(/,/g,""))/100),2),n!=0&&(f=$.number(parseFloat(n.toString().replace(/,/g,""))+parseFloat(s.toString().replace(/,/g,"")),2)),r.plcorBSCost(u>f?u:f);break;default:t!=a.Enums.CustomerType.PLC_Customer.ID&&t!=a.Enums.CustomerType.BillingStation_Customer.ID&&(r.plcorBSCost(0),r.plcorBSRevenue()==0&&r.plcorBSRevenue($.number(parseFloat(n.toString().replace(/,/g,""))/(1-parseFloat(i.toString().replace(/,/g,""))/100),2)))}},n.prototype.addnewRow=function(n){var i=this,t=new g.Models.SalesOrderItemDetail;t.Id=0,t.isUpdated=!1,t.Items=n.items(),t.UserDescription=n.userDescription(),t.Cost=n.cost(),t.Revenue=n.rev(),t.SalesOrderId=n.salesOrderId(),t.ItemId=n.itemId(),t.AccessorialId=n.accessorialId(),t.PLCCost=n.bSCost(),t.ProductCode=n.productCode(),n.itemId()==10?(t.NMFC=n.nmfc(),t.Class=n.selectedClassType(),t.Length=n.dimensionLength(),t.Weight=n.weight(),t.Width-n.dimensionWidth(),t.Height=n.dimensionHeight(),t.Hazardous=n.isHazardous(),t.HazardousUNNo=n.hazmatUnNumber(),t.PalletCount=n.palletCount(),t.PackingGroupNo=n.packingGroup()):(t.Class=null,t.HazardousUNNo=null,t.Height=null,t.Length=null,t.Weight=null,t.Width=null,t.NMFC=null,t.PackageTypes=null,t.PackingGroupNo=null,t.PalletCount=null),i.adjustedOrderItemList().push(t)},n.prototype.copyRow=function(n,t,i){var r=this;r.adjustedOrderItemList().forEach(function(r){r.Id==t&&(r.isUpdated=!1,r.Items=n.items(),r.UserDescription=n.userDescription(),r.Cost=n.cost(),i&&(r.Revenue=n.rev(),r.PLCCost=n.bSCost()),r.SalesOrderId=n.salesOrderId(),r.ItemId=n.itemId(),r.AccessorialId=n.accessorialId(),r.ProductCode=n.productCode(),n.itemId()==10?(r.NMFC=n.nmfc(),r.Class=n.selectedClassType(),r.Length=n.dimensionLength(),r.Weight=n.weight(),r.Width-n.dimensionWidth(),r.Height=n.dimensionHeight(),r.Hazardous=n.isHazardous(),r.HazardousUNNo=n.hazmatUnNumber(),r.PalletCount=n.palletCount(),r.PackingGroupNo=n.packingGroup()):(r.Class=null,r.HazardousUNNo=null,r.Height=null,r.Length=null,r.Weight=null,r.Width=null,r.NMFC=null,r.PackageTypes=null,r.PackingGroupNo=null,r.PalletCount=null))})},n}();t.SalesOrderReBillViewModel=nt})